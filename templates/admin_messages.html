{% extends "base.html" %}

{% block title %}Contact Messages - Cafe Next Door{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">Contact Messages</h1>
        <p class="page-subtitle">View messages sent through the contact form</p>
    </div>
</div>

<div class="admin-section">
    <div class="container">
        <div class="admin-actions">
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
            <div class="filter-controls">
                <label for="filter-select" class="filter-label">Filter:</label>
                <select id="filter-select" class="dropdown-select" onchange="updateFilter(this.value)">
                    <option value="active" {% if filter_type == 'active' %}selected{% endif %}>Active</option>
                    <option value="archived" {% if filter_type == 'archived' %}selected{% endif %}>Archived</option>
                    <option value="all" {% if filter_type == 'all' %}selected{% endif %}>All</option>
                </select>
            </div>
            {% if messages %}
            <div class="sort-controls">
                <label for="sort-select" class="sort-label">Sort by date:</label>
                <select id="sort-select" class="dropdown-select" onchange="updateSort(this.value)">
                    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Newest First</option>
                    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Oldest First</option>
                </select>
            </div>
            {% endif %}
        </div>

        {% if messages %}
            <div class="messages-list">
                {% for message in messages %}
                    <div class="message-card {% if message.get('archived', 0) %}archived{% endif %}">
                        <div class="message-header">
                            <div class="message-sender">
                                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                    <div>
                                <strong>{{ message['name'] }}</strong>
                                <span class="message-email">{{ message['email'] }}</span>
                                    </div>
                                    <div class="message-badges" style="display: inline-flex; gap: 0.5rem; flex-wrap: wrap;">
                                        {% if message.get('replied', 0) %}
                                        <span style="background-color: #4CAF50; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Replied</span>
                                        {% endif %}
                                        {% if message.get('archived', 0) %}
                                        <span style="background: linear-gradient(135deg, #8b6f47 0%, #6b5010 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Archived</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="message-date">
                                {{ message['created_at'] }}
                            </div>
                        </div>
                        <div class="message-body">
                            <p>{{ message['message'] }}</p>
                        </div>
                        <div class="message-actions">
                            <a href="{{ url_for('admin_reply_message', message_id=message['id']) }}" class="btn btn-small btn-reply">
                                <span class="btn-icon">‚úâ</span>
                                Reply
                            </a>
                            <a href="mailto:{{ message['email'] }}?subject=Re: Your message to Cafe Next Door&body=Dear {{ message['name']|replace(' ', '%20') }},%0D%0A%0D%0AThank you for contacting Cafe Next Door. We have received your message and will get back to you soon.%0D%0A%0D%0ABest regards,%0D%0ACafe Next Door Team" class="btn btn-small btn-secondary" target="_blank" style="margin-left: 0.5rem;">
                                <span class="btn-icon">üìß</span>
                                Open Email Client
                            </a>
                            {% if message.get('archived', 0) %}
                            <form method="POST" action="{{ url_for('admin_unarchive_message', message_id=message['id']) }}" style="display: inline;">
                                <button type="submit" class="btn btn-small btn-archive">
                                    <span class="btn-icon">üìÇ</span>
                                    Unarchive
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="{{ url_for('admin_archive_message', message_id=message['id']) }}" style="display: inline;">
                                <button type="submit" class="btn btn-small btn-archive">
                                    <span class="btn-icon">üìÅ</span>
                                    Archive
                                </button>
                            </form>
                            {% endif %}
                            <form method="POST" action="{{ url_for('admin_delete_message', message_id=message['id']) }}" style="display: inline;" onsubmit="return confirm(&quot;Are you sure you want to delete this message from {{ message['name'] }}?&quot;);">
                                <button type="submit" class="btn btn-small btn-delete">
                                    <span class="btn-icon">üóë</span>
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                {% if filter_type == 'active' %}
                    <p>No active messages. Archived messages can be viewed by selecting "Archived" or "All" from the filter.</p>
                {% elif filter_type == 'archived' %}
                    <p>No archived messages yet.</p>
                {% else %}
                    <p>No messages yet. Customer messages will appear here.</p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<script>
function updateFilter(filterValue) {
    const sortValue = document.getElementById('sort-select') ? document.getElementById('sort-select').value : '{{ sort_order }}';
    const baseUrl = "{{ url_for('admin_messages') }}";
    const url = baseUrl + '?filter=' + encodeURIComponent(filterValue) + '&sort=' + encodeURIComponent(sortValue);
    window.location.href = url;
}

function updateSort(sortValue) {
    const filterValue = document.getElementById('filter-select') ? document.getElementById('filter-select').value : '{{ filter_type }}';
    const baseUrl = "{{ url_for('admin_messages') }}";
    const url = baseUrl + '?filter=' + encodeURIComponent(filterValue) + '&sort=' + encodeURIComponent(sortValue);
    window.location.href = url;
}
</script>
{% endblock %}

