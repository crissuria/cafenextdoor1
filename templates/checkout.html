{% extends "base.html" %}

{% block title %}Checkout - Cafe Next Door{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">Checkout</h1>
        <p class="page-subtitle">Complete your order</p>
    </div>
</div>

<div class="checkout-section">
    <div class="container">
        <div class="checkout-content">
            <div class="checkout-form-container">
                <h2>Pickup Details</h2>
                <div class="form-group">
                    <label for="pickup_time">Pickup Time *</label>
                    <select id="pickup_time" name="pickup_time" form="checkout-form" required>
                        <option value="">Select a time</option>
                        <option value="ASAP (15-20 min)">ASAP (15-20 min)</option>
                        <option value="In 30 minutes">In 30 minutes</option>
                        <option value="In 1 hour">In 1 hour</option>
                        <option value="In 2 hours">In 2 hours</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="payment_method">Payment Method <span id="payment_required" style="color: #dc3545;">*</span></label>
                    <select id="payment_method" name="payment_method" form="checkout-form" onchange="togglePaymentProof()">
                        <option value="">Select payment method</option>
                        <option value="Cash">Cash (Pay on Pickup)</option>
                        <option value="GCash">GCash</option>
                        <option value="PayMaya">PayMaya</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                    </select>
                    <small id="payment_help" style="display: block; margin-top: 0.25rem; color: #666;">
                        Required if gift card doesn't cover full amount
                    </small>
                </div>
                
                <div class="form-group" id="payment_proof_group" style="display: none;">
                    <label for="payment_proof">Proof of Payment *</label>
                    <textarea id="payment_proof" name="payment_proof" form="checkout-form" rows="3" placeholder="Enter transaction ID, reference number, or upload screenshot URL..."></textarea>
                    <small>For GCash/PayMaya: Enter transaction ID or reference number. For cards: Enter last 4 digits and authorization code.</small>
                </div>
                
                <div class="form-group">
                    <label for="notes">Special Instructions (optional)</label>
                    <textarea id="notes" name="notes" form="checkout-form" rows="3" placeholder="Any special requests or notes for your order..."></textarea>
                </div>
                
                <a href="{{ url_for('view_cart') }}" class="back-link">← Back to Cart</a>
            </div>
            
            <div class="order-summary">
                <h2>Order Summary</h2>
                <form method="POST" id="checkout-form">
                    <div class="summary-items">
                        {% for item in cart_items %}
                        <div class="summary-item">
                            <div class="summary-item-info">
                                <span class="item-name">{{ item.name }}</span>
                                <span class="item-qty">× {{ item.quantity }}</span>
                            </div>
                            <span class="item-subtotal">P{{ "%.2f"|format(item.subtotal) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>P{{ "%.2f"|format(total) }}</span>
                    </div>
                    
                    <!-- Promo Code Section -->
                    <div class="promo-section">
                        {% if session.promo_code %}
                            <div class="applied-promo">
                                <div class="promo-info">
                                    <strong>{{ session.promo_code }}</strong>
                                    {% if session.promo_discount_type == 'percentage' %}
                                        - {{ session.promo_discount_value|int }}% off
                                    {% else %}
                                        - P{{ "%.2f"|format(session.promo_discount_value) }} off
                                    {% endif %}
                                </div>
                                <button type="button" class="remove-btn" title="Remove" onclick="document.getElementById('remove-promo-form').submit()">×</button>
                            </div>
                            {% set discount = 0 %}
                            {% if session.promo_discount_type == 'percentage' %}
                                {% set discount = total * session.promo_discount_value / 100 %}
                            {% else %}
                                {% set discount = session.promo_discount_value %}
                            {% endif %}
                            {% if discount > total %}{% set discount = total %}{% endif %}
                            <div class="summary-row" style="color: #28a745;">
                                <span>Discount</span>
                                <span>-P{{ "%.2f"|format(discount) }}</span>
                            </div>
                        {% else %}
                            <div class="promo-form-inline">
                                <input type="text" id="promo_input" placeholder="Promo code">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('promo_code_hidden').value = document.getElementById('promo_input').value; document.getElementById('apply-promo-form').submit()">Apply</button>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Gift Card Section -->
                    {% if gift_cards %}
                    <div class="gift-card-section">
                        <div class="form-group" style="margin-top: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="use_gift_card" name="use_gift_card" onchange="toggleGiftCard()">
                                <span>Use Gift Card</span>
                            </label>
                        </div>
                        <div id="gift_card_select" style="display: none; margin-top: 0.5rem;">
                            <select id="gift_card_id" name="gift_card_id" class="form-control">
                                <option value="">Select Gift Card</option>
                                {% for gc in gift_cards %}
                                <option value="{{ gc.id }}" data-balance="{{ gc.balance }}">
                                    {{ gc.code }} - P{{ "%.2f"|format(gc.balance) }} available
                                </option>
                                {% endfor %}
                            </select>
                            <small style="display: block; margin-top: 0.25rem; color: #666;">
                                If gift card doesn't cover full amount, select additional payment method below.
                            </small>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="summary-divider"></div>
                    <div class="summary-row total">
                        <span>Total</span>
                        {% if session.promo_code %}
                            {% set discount = 0 %}
                            {% if session.promo_discount_type == 'percentage' %}
                                {% set discount = total * session.promo_discount_value / 100 %}
                            {% else %}
                                {% set discount = session.promo_discount_value %}
                            {% endif %}
                            {% if discount > total %}{% set discount = total %}{% endif %}
                            <span id="final_total">P{{ "%.2f"|format(total - discount) }}</span>
                        {% else %}
                            <span id="final_total">P{{ "%.2f"|format(total) }}</span>
                        {% endif %}
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full" style="margin-top: 1.5rem;">Place Order</button>
                </form>
                
                <!-- Hidden forms for promo actions -->
                <form method="POST" action="{{ url_for('apply_promo') }}" id="apply-promo-form" style="display:none;">
                    <input type="hidden" name="promo_code" id="promo_code_hidden">
                </form>
                <form method="POST" action="{{ url_for('remove_promo') }}" id="remove-promo-form" style="display:none;"></form>
            </div>
        </div>
    </div>
</div>

<script>
function togglePaymentProof() {
    const paymentMethod = document.getElementById('payment_method').value;
    const proofGroup = document.getElementById('payment_proof_group');
    const proofInput = document.getElementById('payment_proof');
    const useGiftCard = document.getElementById('use_gift_card')?.checked;
    
    if (paymentMethod && paymentMethod !== 'Cash' && !useGiftCard) {
        proofGroup.style.display = 'block';
        proofInput.required = true;
    } else {
        proofGroup.style.display = 'none';
        proofInput.required = false;
        proofInput.value = '';
    }
}

function toggleGiftCard() {
    const useGiftCard = document.getElementById('use_gift_card').checked;
    const giftCardSelect = document.getElementById('gift_card_select');
    const paymentMethod = document.getElementById('payment_method');
    const paymentRequired = document.getElementById('payment_required');
    const paymentHelp = document.getElementById('payment_help');
    
    if (useGiftCard) {
        giftCardSelect.style.display = 'block';
        paymentMethod.required = false;
        if (paymentRequired) paymentRequired.style.display = 'none';
        if (paymentHelp) paymentHelp.textContent = 'Required if gift card doesn\'t cover full amount';
        togglePaymentProof();
    } else {
        giftCardSelect.style.display = 'none';
        document.getElementById('gift_card_id').value = '';
        paymentMethod.required = true;
        if (paymentRequired) paymentRequired.style.display = 'inline';
        if (paymentHelp) paymentHelp.textContent = 'Required';
        togglePaymentProof();
    }
}

// Update total when gift card is selected
document.addEventListener('DOMContentLoaded', function() {
    const giftCardSelect = document.getElementById('gift_card_id');
    if (giftCardSelect) {
        giftCardSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                const balance = parseFloat(selectedOption.dataset.balance);
                const totalElement = document.getElementById('final_total');
                const currentTotal = parseFloat(totalElement.textContent.replace('P', '').replace(',', ''));
                const newTotal = Math.max(0, currentTotal - balance);
                totalElement.textContent = 'P' + newTotal.toFixed(2);
            }
        });
    }
});
</script>
{% endblock %}
